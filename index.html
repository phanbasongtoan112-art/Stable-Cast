<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StableCast</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='%233b82f6' d='M239.1 6.3l-208 78c-18.7 7-31.1 25-31.1 45v225.1c0 18.2 10.3 34.8 26.5 42.9l208 104c13.5 6.8 29.4 6.8 42.9 0l208-104c16.2-8.1 26.5-24.8 26.5-42.9V129.3c0-20-12.4-37.9-31.1-44.9l-208-78C262 2.2 250 2.2 239.1 6.3zM256 68.4l192 72v.3l-192 83.2-192-83.2v-.3l192-72zm-32 158.5v192.6l-160-80V171.8l160 55.1zm64 192.6V226.9l160-55.1v167.6l-160 80z'/></svg>" type="image/svg+xml">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;800&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           GIỮ NGUYÊN 100% CSS GIAO DIỆN CHUYÊN NGHIỆP
           ========================================= */
        :root {
            --bg-dark: #050608;
            --bg-gradient: radial-gradient(circle at 50% -20%, #111a2e 0%, #030406 100%);
            --panel-bg: rgba(13, 16, 23, 0.55);
            --border-light: rgba(255, 255, 255, 0.08);
            --text-main: #e2e8f0;
            --text-muted: #8492a6;
            --up-color: #00d283; 
            --down-color: #ff3b5e; 
            --accent-color: #3b82f6; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background: var(--bg-dark); 
            background-image: var(--bg-gradient);
            color: var(--text-main); 
            font-family: 'JetBrains Mono', monospace; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            -webkit-font-smoothing: antialiased;
        }
        
        ::-webkit-scrollbar { width: 5px; } 
        ::-webkit-scrollbar-track { background: transparent; } 
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* LOGIN SCREEN */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(3,4,6,0.85); backdrop-filter: blur(20px); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        .login-box { 
            width: 90%; max-width: 420px; padding: 40px; 
            background: linear-gradient(145deg, rgba(20,24,33,0.7), rgba(10,12,16,0.9)); 
            border: 1px solid var(--border-light); 
            border-radius: 20px; 
            box-shadow: 0 15px 50px rgba(0,0,0,0.9), inset 0 1px 0 rgba(255,255,255,0.1); 
            text-align: center; 
            position: relative;
            overflow: hidden;
        }
        
        .login-box::before {
            content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--up-color), transparent);
            animation: scanline 3s linear infinite;
        }
        @keyframes scanline { 0% {left: -100%;} 100% {left: 100%;} }

        .login-box h2 { 
            color: #fff; margin-bottom: 30px; letter-spacing: 3px; 
            border-bottom: 2px solid var(--up-color); display: inline-block; padding-bottom: 10px; 
            text-shadow: 0 0 15px rgba(0, 210, 131, 0.5); font-family: 'JetBrains Mono', monospace;
        }
        
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; color: var(--text-muted); font-size: 0.75rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .input-group input { width: 100%; padding: 14px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--up-color); font-size: 1rem; outline: none; transition: all 0.3s; font-family: 'JetBrains Mono', monospace; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); }
        .input-group input:focus { border-color: var(--up-color); box-shadow: 0 0 15px rgba(0, 210, 131, 0.3), inset 0 2px 5px rgba(0,0,0,0.5); }
        
        button#mainAuthBtn { 
            width: 100%; padding: 14px; margin-top: 10px; 
            background: linear-gradient(90deg, #00d283, #009960); 
            color: #000; font-weight: 800; border: none; border-radius: 8px; 
            cursor: pointer; font-size: 1rem; transition: all 0.3s; 
            letter-spacing: 2px; font-family: 'JetBrains Mono', monospace; text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0, 210, 131, 0.4);
        }
        button#mainAuthBtn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 210, 131, 0.6); }
        
        .toggle-auth { margin-top: 25px; font-size: 0.75rem; color: var(--text-muted); cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .toggle-auth:hover { color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        #loginMsg { margin-top: 20px; font-size: 0.85rem; font-weight: 600; min-height: 20px; }
        .secure-text { margin-top: 25px; color: #555; font-size: 0.7rem; letter-spacing: 2px; text-transform: uppercase; }

        /* MAIN APP */
        .main-app { display: none; height: 100%; flex-direction: column; opacity: 0; transition: opacity 1s; }
        
        header { 
            height: 70px; background: rgba(5,6,8,0.7); backdrop-filter: blur(15px); 
            border-bottom: 1px solid var(--border-light); 
            display: flex; justify-content: space-between; align-items: center; padding: 0 25px; 
            box-shadow: 0 5px 25px rgba(0,0,0,0.5); z-index: 10;
        }
        .brand { font-family: 'Rajdhani', sans-serif; font-size: 2rem; font-weight: 700; letter-spacing: 1.5px; color: #fff; display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--accent-color); text-shadow: 0 0 15px rgba(59, 130, 246, 0.8); }
        .brand sup { font-family: 'JetBrains Mono'; font-size: 0.6rem; color: #aaa; background: rgba(255,255,255,0.05); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); letter-spacing: 0; margin-left: 5px; }
        .market-ticker { display: flex; gap: 25px; font-size: 0.85rem; letter-spacing: 0.5px; }

        .grid-container { 
            flex: 1; display: grid; grid-template-columns: 280px 1fr 340px; gap: 15px; 
            padding: 15px; overflow: hidden; 
        }

        .panel { 
            background: var(--panel-bg); backdrop-filter: blur(15px);
            border: 1px solid var(--border-light); border-radius: 16px; 
            padding: 20px; overflow-y: auto; display: flex; flex-direction: column; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .panel:hover {
            box-shadow: 0 15px 50px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .panel-header { 
            font-size: 0.8rem; color: #fff; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; 
        }
        .panel-header i { color: var(--accent-color); text-shadow: 0 0 10px rgba(59,130,246,0.5); }

        .ob-row { display: flex; justify-content: space-between; margin-bottom: 3px; padding: 4px 6px; font-size: 0.75rem; border-radius: 4px; transition: background 0.2s; cursor: default; }
        .ob-row:hover { background: rgba(255,255,255,0.1); transform: scale(1.02); }
        .bg-red-soft { background: rgba(255, 59, 94, 0.05); }
        .bg-green-soft { background: rgba(0, 210, 131, 0.05); }

        .chart-wrapper { flex: 2; position: relative; min-height: 0; }
        .indicator-wrapper { flex: 1; position: relative; min-height: 0; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 15px; margin-top: 10px; }
        .price-overlay { position: absolute; top: 10px; left: 10px; z-index: 10; pointer-events: none; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .main-price { font-size: 4rem; font-weight: 700; color: var(--up-color); font-family: 'Rajdhani', sans-serif; line-height: 1; text-shadow: 0 0 25px rgba(0, 210, 131, 0.4); transition: color 0.3s, text-shadow 0.3s; }

        .ai-confidence { text-align: center; padding-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .conf-circle { 
            width: 140px; height: 140px; border-radius: 50%; 
            border: 4px solid var(--border-light); margin: 10px auto 0; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: all 0.5s; background: radial-gradient(circle, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.6) 100%); 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }
        .conf-value { font-size: 2.8rem; font-weight: 700; color: #fff; font-family: 'Rajdhani', sans-serif; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .conf-label { font-size: 0.7rem; color: var(--text-muted); letter-spacing: 2px; }

        .signal-box { 
            background: rgba(0,0,0,0.5); padding: 18px; 
            border: 1px solid var(--border-light); border-radius: 12px; 
            margin-top: 20px; text-align: center; transition: all 0.5s; 
            box-shadow: inset 0 2px 15px rgba(0,0,0,0.5);
        }
        .signal-text { font-size: 2rem; font-weight: 800; letter-spacing: 4px; color: #fff; font-family: 'Rajdhani', sans-serif; transition: all 0.5s; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        .params-box { background: rgba(0,0,0,0.3); padding: 15px; border: 1px solid var(--border-light); border-radius: 12px; margin-top: 15px; }
        .param-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.8rem; }
        .param-label { color: var(--text-muted); }
        .param-val { color: #fff; font-weight: 600; font-family: 'JetBrains Mono', monospace; text-shadow: 0 1px 5px rgba(0,0,0,0.8); }

        .news-feed { flex: 1; overflow-y: auto; margin-top: 15px; padding-right: 5px; min-height: 150px; }
        .news-item { 
            margin-bottom: 12px; padding: 15px; 
            background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); 
            border: 1px solid rgba(255,255,255,0.05); 
            border-radius: 10px; transition: all 0.3s; cursor: pointer; 
            display: block; text-decoration: none; color: inherit; 
        }
        .news-item:hover { 
            background: rgba(255,255,255,0.08); 
            border-color: rgba(255,255,255,0.15); 
            transform: translateY(-3px) scale(1.02); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.4); 
        }
        .news-title { font-size: 0.85rem; font-weight: 600; color: #fff; margin-bottom: 10px; line-height: 1.4; }
        .news-meta { font-size: 0.65rem; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; }
        .sentiment-tag { padding: 4px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; letter-spacing: 0.5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .sent-pos { background: rgba(0, 210, 131, 0.15); color: var(--up-color); border: 1px solid rgba(0, 210, 131, 0.4); }
        .sent-neg { background: rgba(255, 59, 94, 0.15); color: var(--down-color); border: 1px solid rgba(255, 59, 94, 0.4); }

        .project-footer { background: rgba(4,5,7,0.9); backdrop-filter: blur(10px); border-top: 1px solid var(--border-light); padding: 12px 20px; text-align: center; font-size: 0.7rem; color: #666; line-height: 1.5; z-index: 10; }
        .highlight-text { color: #aaa; font-weight: bold; }

        @keyframes pulse-icon { 0% {opacity: 1; text-shadow: 0 0 15px var(--up-color);} 50% {opacity: 0.4; text-shadow: 0 0 0px transparent;} 100% {opacity: 1; text-shadow: 0 0 15px var(--up-color);} }
        .fa-circle-notch { animation: fa-spin 2s linear infinite, pulse-icon 1.5s ease-in-out infinite; }

        @media (max-width: 1024px) {
            body { height: auto; overflow-y: auto; }
            .main-app { height: auto; }
            header { flex-direction: column; height: auto; padding: 15px; gap: 12px; text-align: center; }
            .grid-container { grid-template-columns: 1fr; gap: 15px; overflow: visible; padding: 10px; }
            .chart-wrapper { min-height: 380px; }
            .indicator-wrapper { min-height: 180px; }
            .main-price { font-size: 3rem; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 id="authTitle">LOGIN</h2>
            <div class="input-group">
                <label>USER NAME</label>
                <input type="text" id="email" placeholder="USERNAME">
            </div>
            <div class="input-group">
                <label>PASSWORD</label>
                <input type="password" id="password" placeholder="••••••">
            </div>
            <div style="text-align: left; margin-bottom: 25px; display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="rememberMe" checked style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--up-color);">
                <label for="rememberMe" style="font-size: 0.8rem; cursor: pointer; color: #888; font-weight: normal; margin:0; letter-spacing: 0;">Remember Me</label>
            </div>
            <div id="loginMsg"></div>
            <button id="mainAuthBtn">LOGIN</button>
            <div class="toggle-auth" id="toggleAuthBtn">NEED AN ACCOUNT? REGISTER</div>
        </div>
        <div class="secure-text"><i class="fas fa-shield-alt"></i> PROJECT BY TEAM 1</div>
    </div>

    <div class="main-app" id="mainApp">
        <header>
            <div class="brand"><i class="fas fa-cube" style="color: var(--accent-color);"></i> STABLE<span>CAST</span> <sup>TEAM 1 - ADY201m</sup></div>
            <div class="market-ticker" id="tickerStatus" style="color:var(--up-color); font-weight: 600;"><i class="fas fa-circle-notch fa-spin"></i> SYNCING...</div>
        </header>

        <div class="grid-container">
            <div class="panel">
                <div class="panel-header"><span>Order Book (BTC/USDT)</span> <i class="fas fa-list-ul"></i></div>
                <div id="orderBook" style="font-family:'JetBrains Mono'; font-weight: 600;"></div> 
                
                <div class="panel-header" style="margin-top:25px;"><span>System Diagnostics</span> <i class="fas fa-microchip"></i></div>
                <div style="font-size:0.8rem; color:#aaa; font-weight: 500;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>Network Latency</span> <span style="color:var(--up-color); text-shadow: 0 0 8px var(--up-color);">12ms</span></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>Tensor RAM</span> <span>14.2 GB</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Data Origin</span> <span style="color:#fff;">Binance WSS</span></div>
                </div>
            </div>

            <div class="panel" style="padding:0; overflow: hidden;">
                <div class="chart-wrapper">
                    <div class="price-overlay">
                        <div style="font-size:0.75rem; color:#888; font-weight:700; letter-spacing: 1px; display: flex; gap: 15px; align-items: center; margin-bottom: 5px;">
                            BTC/USDT PERP
                            <span style="color: var(--up-color); font-size: 0.65rem; background: rgba(0,210,131,0.1); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(0,210,131,0.2);">■ REAL-TIME</span>
                            <span style="color: var(--accent-color); font-size: 0.65rem; background: rgba(59,130,246,0.1); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(59,130,246,0.2);">╍ AI FORECAST</span>
                        </div>
                        <div class="main-price" id="mainPrice">LOADING</div>
                        <div id="priceChange" style="color:var(--up-color); font-weight:700; font-size: 1.1rem; margin-top: 5px;">+0.00%</div>
                    </div>
                    <canvas id="priceChart"></canvas>
                </div>
                <div class="indicator-wrapper">
                    <div style="position:absolute; top:5px; left:15px; font-size:0.7rem; color:#888; font-weight:700; letter-spacing: 1px;">RSI (14) OSCILLATOR</div>
                    <canvas id="indicatorChart"></canvas>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header"><span>Prediction Engine</span> <i class="fas fa-brain"></i></div>
                
                <div class="ai-confidence">
                    <div style="margin-bottom: 15px;">
                        <div style="font-size:0.75rem; color:var(--accent-color); text-transform:uppercase; font-weight:700; letter-spacing: 1px; margin-bottom:5px;">Target Price (1H)</div>
                        <div id="aiPredPrice" style="font-size:2.4rem; font-weight:800; color:#fff; font-family:'Rajdhani', sans-serif; text-shadow: 0 0 15px rgba(255,255,255,0.2);">---</div>
                    </div>
                    <div class="conf-circle" id="confCircle">
                        <div class="conf-value" id="aiConf">--%</div>
                        <div class="conf-label">CONFIDENCE</div>
                    </div>
                </div>

                <div class="signal-box" id="signalBox">
                    <div style="font-size:0.7rem; color:#aaa; margin-bottom: 8px; font-weight: 600; letter-spacing: 1px;">ALGORITHMIC ACTION</div>
                    <div class="signal-text" id="aiSignal">ANALYZING</div>
                </div>

                <div class="params-box">
                    <div class="param-row"><span class="param-label">Stop Loss (ATR)</span> <span class="param-val" id="slVal" style="color:var(--down-color)">---</span></div>
                    <div class="param-row"><span class="param-label">Take Profit</span> <span class="param-val" id="tpVal" style="color:var(--up-color)">---</span></div>
                    <div class="param-row" style="border-top:1px solid rgba(255,255,255,0.05); padding-top:10px; margin-top:10px;">
                        <span class="param-label">RSI (14)</span> <span class="param-val" id="rsiVal">---</span>
                    </div>
                    <div class="param-row" style="margin-bottom:0;"><span class="param-label">MACD (12,26)</span> <span class="param-val" id="macdVal">---</span></div>
                </div>

                <div class="panel-header" style="margin-top:25px;"><span>Global Sentiment</span> <i class="fas fa-globe-americas"></i></div>
                <div class="news-feed" id="newsFeed"></div>
            </div>
        </div>

        <div class="project-footer">
            <span class="highlight-text">DISCLAIMER:</span> This project is developed for educational purposes within the <span class="highlight-text">ADY201m course (FPT University)</span>. 
            All data, market indicators, and AI predictions are simulated for demonstration only and do not hold real-world financial value. 
            &copy; 2026 StableCast Project.
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const loginOverlay = document.getElementById('loginOverlay');
            const mainApp = document.getElementById('mainApp');
            const btnLogin = document.getElementById('mainAuthBtn');
            const toggleBtn = document.getElementById('toggleAuthBtn');
            const title = document.getElementById('authTitle');
            const msg = document.getElementById('loginMsg');
            let isRegister = false;

            // --- SỬA LẠI LOGIC CHUYỂN ĐỔI LOGIN/REGISTER CHO ĐÚNG ---
            toggleBtn.addEventListener('click', () => {
                isRegister = !isRegister;
                msg.textContent = "";
                if(isRegister) {
                    title.textContent = "REGISTER";
                    btnLogin.textContent = "REGISTER";
                    toggleBtn.textContent = "ALREADY A MEMBER? LOGIN";
                    btnLogin.style.background = "linear-gradient(90deg, #3b82f6, #2563eb)";
                    btnLogin.style.boxShadow = "0 4px 15px rgba(59, 130, 246, 0.4)";
                    title.style.borderBottomColor = "#3b82f6";
                    title.style.textShadow = "0 0 10px rgba(59, 130, 246, 0.4)";
                } else {
                    title.textContent = "LOGIN";
                    btnLogin.textContent = "LOGIN";
                    toggleBtn.textContent = "NEED AN ACCOUNT? REGISTER";
                    btnLogin.style.background = "linear-gradient(90deg, #00d283, #009960)";
                    btnLogin.style.boxShadow = "0 4px 15px rgba(0, 210, 131, 0.4)";
                    title.style.borderBottomColor = "#00d283";
                    title.style.textShadow = "0 0 10px rgba(0, 210, 131, 0.4)";
                }
            });

            btnLogin.addEventListener('click', () => {
                const u = document.getElementById('email').value;
                const p = document.getElementById('password').value;
                if(!u && !p && !isRegister) { enterApp(); return; }
                if(!u || !p) { msg.style.color = "var(--down-color)"; msg.textContent = "Credentials required."; return; }
                if(isRegister) {
                    msg.style.color = "#3b82f6"; msg.textContent = "Registration Success! Please Login.";
                    setTimeout(() => toggleBtn.click(), 1000);
                } else { enterApp(); }
            });

            function enterApp() {
                msg.style.color = "var(--up-color)";
                msg.textContent = "CONNECTING... STANDBY.";
                setTimeout(() => {
                    loginOverlay.style.opacity = 0;
                    setTimeout(() => {
                        loginOverlay.style.display = 'none';
                        mainApp.style.display = 'flex';
                        setTimeout(() => mainApp.style.opacity = 1, 100);
                        initNewsEngine(); 
                        startCoreEngine();
                    }, 500);
                }, 800);
            }

            // --- NEWS ENGINE ---
            let globalNewsArray = [
                { title: "Bitcoin approaches key resistance level amidst market uncertainty", source: "CoinTelegraph", time: "Just now", sentiment: "pos", url: "https://cointelegraph.com" },
                { title: "SEC delays decision on latest Ethereum ETF applications", source: "CoinDesk", time: "5 mins ago", sentiment: "neg", url: "https://coindesk.com" },
                { title: "Whale activity spikes as $500M USDT moves to Binance", source: "CryptoQuant", time: "12 mins ago", sentiment: "neg", url: "https://cryptoquant.com" },
                { title: "New AI models show unprecedented accuracy in crypto forecasting", source: "Forbes", time: "1 hr ago", sentiment: "pos", url: "https://forbes.com" },
                { title: "Market volatility expected to increase ahead of Fed meeting", source: "Bloomberg", time: "2 hrs ago", sentiment: "neg", url: "https://bloomberg.com" }
            ];

            let lastTimeIndex = -1;

            function renderNews() {
                const feed = document.getElementById('newsFeed');
                if(!feed || globalNewsArray.length === 0) return;
                
                let timeIndex = Math.floor(Date.now() / 6000);
                if(timeIndex === lastTimeIndex) return; 
                lastTimeIndex = timeIndex;

                let html = '';
                let startIndex = timeIndex % globalNewsArray.length;

                for(let i = 0; i < Math.min(4, globalNewsArray.length); i++) {
                    const item = globalNewsArray[(startIndex + i) % globalNewsArray.length];
                    const label = item.sentiment === 'pos' ? "BULLISH" : "BEARISH";
                    const sentClass = item.sentiment === 'pos' ? "sent-pos" : "sent-neg";
                    html += `
                        <a href="${item.url}" target="_blank" class="news-item">
                            <div class="news-title">${item.title}</div>
                            <div class="news-meta">
                                <span><i class="fas fa-newspaper"></i> ${item.source} • ${item.time}</span>
                                <span class="sentiment-tag ${sentClass}">${label}</span>
                            </div>
                        </a>
                    `;
                }
                feed.innerHTML = html;
            }

            function initNewsEngine() {
                renderNews(); 
                setInterval(renderNews, 1000); 

                fetch('https://min-api.cryptocompare.com/data/v2/news/?lang=EN')
                    .then(res => res.json())
                    .then(data => {
                        if(data && data.Data && data.Data.length > 0) {
                            globalNewsArray = data.Data.map(article => {
                                const titleLower = article.title.toLowerCase();
                                let sent = "pos";
                                if(titleLower.match(/(drop|bear|crash|hack|sec|ban|sell|fall|down|worry|plunge|fraud|delay)/)) {
                                    sent = "neg";
                                }
                                const date = new Date(article.published_on * 1000);
                                const timeStr = ("0" + date.getHours()).slice(-2) + ":" + ("0" + date.getMinutes()).slice(-2);
                                return {
                                    title: article.title,
                                    source: article.source_info.name,
                                    time: timeStr,
                                    sentiment: sent,
                                    url: article.url
                                };
                            });
                            lastTimeIndex = -1; 
                            renderNews();
                        }
                    }).catch(e => console.log("Using local fallback news."));
            }

            // --- CORE ENGINE ---
            async function startCoreEngine() {
                let history = [];
                let aiHistory = []; 
                let labels = [];

                try {
                    const res = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=100');
                    const data = await res.json();
                    history = data.map(d => parseFloat(d[4]));
                    labels = data.map((_, i) => i);
                    aiHistory = history.map(p => p + (Math.sin(p) - 0.5) * (p * 0.0015)); 
                    document.getElementById('tickerStatus').innerHTML = '<i class="fas fa-check-circle"></i> BINANCE SECURE LINK';
                } catch (e) {
                    let price = 43250.00;
                    history = Array.from({length: 100}, (_, i) => { price += Math.sin(i) * 100; return price; });
                    aiHistory = history.map(p => p + Math.cos(p) * 50);
                    labels = Array.from({length: 100}, (_,i) => i);
                }

                Chart.defaults.color = '#8492a6';
                Chart.defaults.font.family = "'JetBrains Mono', monospace";

                const ctxP = document.getElementById('priceChart').getContext('2d');
                const pChart = new Chart(ctxP, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Real Price', data: history, borderColor: '#00d283', borderWidth: 2.5, pointRadius: 0, fill: true,
                                backgroundColor: (ctx) => {
                                    const grad = ctx.chart.ctx.createLinearGradient(0,0,0,400);
                                    grad.addColorStop(0, 'rgba(0, 210, 131, 0.25)'); grad.addColorStop(1, 'rgba(0, 210, 131, 0)');
                                    return grad;
                                }, tension: 0.2
                            },
                            {
                                label: 'AI Forecast', data: aiHistory, borderColor: '#3b82f6', borderWidth: 2, borderDash: [6, 6], pointRadius: 0, fill: false, tension: 0.2
                            }
                        ]
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false, animation: false, plugins: {legend: false}, 
                        scales: {x:{display:false}, y:{position:'right', grid:{color:'rgba(255,255,255,0.05)', drawBorder: false}}} 
                    }
                });

                const ctxI = document.getElementById('indicatorChart').getContext('2d');
                const iChart = new Chart(ctxI, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: 'RSI', data: calcRSI(history), borderColor: '#3b82f6', borderWidth: 1.5, pointRadius: 0 }] },
                    options: { 
                        responsive: true, maintainAspectRatio: false, animation: false, plugins: {legend: false}, 
                        scales: {x:{display:false}, y:{position:'right', min:0, max:100, grid:{color:'rgba(255,255,255,0.05)', drawBorder: false}}} 
                    }
                });

                const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@ticker');
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    const currentPrice = parseFloat(data.c); 
                    const changePercent = parseFloat(data.P);

                    history.shift(); history.push(currentPrice);
                    
                    const rsiData = calcRSI(history);
                    const currentRSI = rsiData[rsiData.length - 1];
                    const macdArray = calcMACD(history);
                    const currentMACD = macdArray[macdArray.length - 1];

                    const predPrice = updateAI(currentRSI, currentMACD, changePercent, currentPrice);
                    
                    aiHistory.shift(); aiHistory.push(predPrice);

                    pChart.data.datasets[0].data = history; 
                    pChart.data.datasets[1].data = aiHistory; 
                    pChart.update(); 
                    
                    iChart.data.datasets[0].data = rsiData;
                    iChart.update();

                    const elP = document.getElementById('mainPrice');
                    elP.innerText = currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    
                    if(changePercent >= 0) {
                        elP.style.color = "var(--up-color)";
                        elP.style.textShadow = "0 0 25px rgba(0, 210, 131, 0.5)";
                    } else {
                        elP.style.color = "var(--down-color)";
                        elP.style.textShadow = "0 0 25px rgba(255, 59, 94, 0.5)";
                    }
                    
                    const elC = document.getElementById('priceChange');
                    elC.innerText = (changePercent >= 0 ? "+" : "") + changePercent.toFixed(2) + "%";
                    elC.style.color = changePercent >= 0 ? "var(--up-color)" : "var(--down-color)";

                    updateOrderBook(currentPrice);
                };
            }

            // --- MATH HELPERS ---
            function calcEMA(data, period) {
                let k = 2/(period+1), ema=data[0], res=[];
                data.forEach(p => { ema = p*k + ema*(1-k); res.push(ema); });
                return res;
            }

            function calcMACD(data) {
                let ema12 = calcEMA(data, 12);
                let ema26 = calcEMA(data, 26);
                let macd = [];
                for(let i=0; i<data.length; i++) macd.push(ema12[i] - ema26[i]);
                return macd;
            }

            function calcRSI(data) {
                let res = Array(14).fill(50);
                for(let i=14; i<data.length; i++) {
                    let up = 0, down = 0;
                    for(let j=i-14; j<i; j++) {
                        let diff = data[j+1] - data[j];
                        if(diff > 0) up += diff; else down -= diff;
                    }
                    if (down === 0) res.push(100);
                    else res.push(100 - (100 / (1 + up / down)));
                }
                return res;
            }

            function updateOrderBook(p) {
                let h = "";
                for(let i=5; i>0; i--) {
                    let fakeQty = Math.abs(Math.sin(p * i)) * 2; 
                    h += `<div class="ob-row bg-red-soft"><span style="color:var(--down-color)">${(p+i*1.5).toFixed(2)}</span> <span style="color:#aaa">${fakeQty.toFixed(3)}</span></div>`;
                }
                h += `<div style="text-align:center; color:#fff; font-size:1.1rem; padding: 6px 0; border-top:1px solid rgba(255,255,255,0.05); border-bottom:1px solid rgba(255,255,255,0.05); margin:6px 0; text-shadow: 0 0 10px rgba(255,255,255,0.3);">${p.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>`;
                for(let i=1; i<=5; i++) {
                    let fakeQty = Math.abs(Math.cos(p * i)) * 2;
                    h += `<div class="ob-row bg-green-soft"><span style="color:var(--up-color)">${(p-i*1.5).toFixed(2)}</span> <span style="color:#aaa">${fakeQty.toFixed(3)}</span></div>`;
                }
                document.getElementById('orderBook').innerHTML = h;
            }

            // --- CẬP NHẬT AI ---
            function updateAI(rsi, macd, chg, price) {
                let sig = "HOLD", col = "#8492a6"; 
                let hexOpacity = "33"; 
                
                let pseudoRand1 = Math.abs(Math.sin(price * 100)); 
                let pseudoRand2 = Math.abs(Math.cos(price * 100));

                let conf = 45 + pseudoRand1 * 15; 
                let predOffset = (pseudoRand2 - 0.5) * (price * 0.001);

                if (rsi > 65 || (macd < 0 && chg < -0.5)) {
                    sig = "SELL"; col = "#ff3b5e"; hexOpacity = "66";
                    conf = 65 + pseudoRand1 * 15;
                    predOffset = -(price * (0.005 + pseudoRand2 * 0.005));
                    if(rsi > 75) { sig = "STRONG SELL"; conf += 5; }
                } 
                else if (rsi < 35 || (macd > 0 && chg > 0.5)) {
                    sig = "BUY"; col = "#00d283"; hexOpacity = "66"; 
                    conf = 65 + pseudoRand1 * 15;
                    predOffset = (price * (0.005 + pseudoRand2 * 0.005));
                    if(rsi < 25) { sig = "STRONG BUY"; conf += 5; }
                }

                if(conf > 88.5) conf = 88.5 - pseudoRand1;

                const predPrice = price + predOffset;

                let sl, tp;
                if(sig.includes("BUY")) {
                    sl = price * 0.985; tp = price * 1.03;
                } else if(sig.includes("SELL")) {
                    sl = price * 1.015; tp = price * 0.97;
                } else {
                    sl = price * 0.99; tp = price * 1.01;
                }

                const sigBox = document.getElementById('signalBox');
                document.getElementById('aiSignal').innerText = sig;
                document.getElementById('aiSignal').style.color = col;
                document.getElementById('aiSignal').style.textShadow = `0 0 20px ${col}${hexOpacity}`;
                
                sigBox.style.borderColor = col;
                sigBox.style.boxShadow = `inset 0 0 25px ${col}33`;
                
                document.getElementById('aiConf').innerText = conf.toFixed(1) + "%";
                const circle = document.querySelector('.conf-circle');
                circle.style.borderColor = col;
                circle.style.boxShadow = `0 0 30px ${col}55, inset 0 0 15px ${col}22`;

                document.getElementById('aiPredPrice').innerText = predPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('aiPredPrice').style.color = col;
                document.getElementById('aiPredPrice').style.textShadow = `0 0 20px ${col}55`;

                document.getElementById('slVal').innerText = sl.toLocaleString('en-US', {minimumFractionDigits: 2});
                document.getElementById('tpVal').innerText = tp.toLocaleString('en-US', {minimumFractionDigits: 2});
                
                document.getElementById('rsiVal').innerText = rsi.toFixed(2);
                document.getElementById('rsiVal').style.color = rsi > 70 ? "var(--down-color)" : (rsi < 30 ? "var(--up-color)" : "#fff");
                document.getElementById('rsiVal').style.textShadow = rsi > 70 ? "0 0 10px var(--down-color)" : (rsi < 30 ? "0 0 10px var(--up-color)" : "none");

                document.getElementById('macdVal').innerText = macd.toFixed(2);
                document.getElementById('macdVal').style.color = macd > 0 ? "var(--up-color)" : "var(--down-color)";
                document.getElementById('macdVal').style.textShadow = macd > 0 ? "0 0 10px var(--up-color)" : "0 0 10px var(--down-color)";

                return predPrice; 
            }
        });
    </script>
</body>
</html>
