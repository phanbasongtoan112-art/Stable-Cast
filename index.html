<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StableCast</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='%233b82f6' d='M239.1 6.3l-208 78c-18.7 7-31.1 25-31.1 45v225.1c0 18.2 10.3 34.8 26.5 42.9l208 104c13.5 6.8 29.4 6.8 42.9 0l208-104c16.2-8.1 26.5-24.8 26.5-42.9V129.3c0-20-12.4-37.9-31.1-44.9l-208-78C262 2.2 250 2.2 239.1 6.3zM256 68.4l192 72v.3l-192 83.2-192-83.2v-.3l192-72zm-32 158.5v192.6l-160-80V171.8l160 55.1zm64 192.6V226.9l160-55.1v167.6l-160 80z'/></svg>" type="image/svg+xml">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CONFIG --- */
        :root {
            --bg-color: #050505;
            --panel-bg: #0b0c10;
            --border-color: #1f2937;
            --text-main: #e5e7eb;
            --text-muted: #6b7280;
            --up-color: #0ecb81; 
            --down-color: #f6465d; 
            --accent-color: #3b82f6; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        /* Mặc định trên PC: Khóa cuộn trang (overflow: hidden), full màn hình */
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'JetBrains Mono', monospace; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: #000; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* --- LOGIN SCREEN --- */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-box { width: 90%; max-width: 420px; padding: 40px; background: #111; border: 1px solid #333; box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); text-align: center; }
        .login-box h2 { color: #fff; margin-bottom: 30px; letter-spacing: 2px; border-bottom: 2px solid var(--up-color); display: inline-block; padding-bottom: 10px; font-family: 'JetBrains Mono', monospace; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; color: #848e9c; font-size: 0.75rem; margin-bottom: 5px; text-transform: uppercase; }
        .input-group input { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: var(--up-color); font-size: 1rem; outline: none; transition: border 0.3s; font-family: 'JetBrains Mono', monospace;}
        .input-group input:focus { border-color: var(--up-color); }
        button#mainAuthBtn { width: 100%; padding: 12px; margin-top: 10px; background: var(--up-color); color: #000; font-weight: bold; border: none; cursor: pointer; font-size: 1rem; transition: all 0.3s; font-family: 'JetBrains Mono', monospace; text-transform: uppercase; }
        button#mainAuthBtn:hover { opacity: 0.9; box-shadow: 0 0 15px rgba(14, 203, 129, 0.4); }
        .toggle-auth { margin-top: 20px; font-size: 0.75rem; color: #888; cursor: pointer; text-decoration: underline; }
        #loginMsg { margin-top: 20px; font-size: 0.85rem; min-height: 20px; }
        .secure-text { margin-top: 20px; color: #444; font-size: 0.7rem; letter-spacing: 1px; }

        /* --- MAIN INTERFACE --- */
        .main-app { display: none; height: 100%; flex-direction: column; opacity: 0; transition: opacity 1s; }
        
        header { height: 60px; background: var(--panel-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .brand { font-family: 'Rajdhani', sans-serif; font-size: 1.8rem; font-weight: bold; letter-spacing: 1px; color: #fff; }
        .brand span { color: var(--accent-color); }
        .market-ticker { display: flex; gap: 20px; font-size: 0.85rem; }

        .grid-container { flex: 1; display: grid; grid-template-columns: 280px 1fr 340px; gap: 1px; background: var(--border-color); overflow: hidden; }
        .panel { background: var(--bg-color); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
        .panel-header { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; min-height: 20px; }

        .ob-row { display: flex; justify-content: space-between; margin-bottom: 2px; padding: 2px 0; font-size: 0.75rem; }
        .bg-red-soft { background: rgba(246, 70, 93, 0.1); }
        .bg-green-soft { background: rgba(14, 203, 129, 0.1); }

        .chart-wrapper { flex: 2; position: relative; min-height: 0; }
        .indicator-wrapper { flex: 1; position: relative; min-height: 0; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .price-overlay { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; }
        .main-price { font-size: 3.5rem; font-weight: bold; color: var(--up-color); font-family: 'Rajdhani', sans-serif; line-height: 1; }

        /* --- CỘT PHẢI --- */
        .ai-confidence { text-align: center; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .conf-circle { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--border-color); margin: 0 auto; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: border-color 0.5s; }
        .conf-value { font-size: 2rem; font-weight: bold; color: #fff; }
        .conf-label { font-size: 0.7rem; color: var(--text-muted); }
        
        .signal-box { background: #111; padding: 15px; border: 1px solid #333; border-radius: 4px; margin-top: 15px; text-align: center; transition: border-color 0.5s; }
        .signal-text { font-size: 1.5rem; font-weight: bold; letter-spacing: 2px; color: #fff; transition: color 0.5s; }

        .params-box { background: #111; padding: 12px; border: 1px solid #333; border-radius: 4px; margin-top: 15px; }
        .param-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.8rem; }
        .param-label { color: #888; }
        .param-val { color: #fff; font-weight: bold; font-family: 'JetBrains Mono', monospace; }

        .news-feed { flex: 1; overflow-y: auto; margin-top: 15px; padding-right: 5px; min-height: 150px; }
        .news-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #222; transition: opacity 0.3s; cursor: pointer; display: block; text-decoration: none; color: inherit; }
        .news-item:hover { opacity: 0.7; }
        .news-title { font-size: 0.85rem; font-weight: bold; color: #fff; margin-bottom: 6px; line-height: 1.3; }
        .news-meta { font-size: 0.65rem; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; }
        .sentiment-tag { padding: 2px 6px; border-radius: 2px; font-size: 0.65rem; font-weight: bold; }
        .sent-pos { background: rgba(14, 203, 129, 0.2); color: var(--up-color); }
        .sent-neg { background: rgba(246, 70, 93, 0.2); color: var(--down-color); }

        .project-footer { background: #080808; border-top: 1px solid #222; padding: 10px 20px; text-align: center; font-size: 0.7rem; color: #555; line-height: 1.4; }
        .highlight-text { color: #888; font-weight: bold; }

        /* =========================================
           3. RESPONSIVE CHO ĐIỆN THOẠI (KHÔNG ẢNH HƯỞNG MÁY TÍNH)
           ========================================= */
        @media (max-width: 1024px) {
            body { 
                height: auto; 
                overflow-y: auto; /* Mở khóa cuộn trang trên đt */
            }
            .main-app { 
                height: auto; 
            }
            header {
                flex-direction: column; /* Xếp Header dọc */
                height: auto;
                padding: 15px;
                gap: 10px;
                text-align: center;
            }
            .grid-container {
                grid-template-columns: 1fr; /* CHUYỂN TỪ 3 CỘT THÀNH 1 CỘT DỌC */
                gap: 10px;
                overflow: visible;
            }
            .chart-wrapper {
                min-height: 350px; /* Cấp không gian cho biểu đồ vẽ */
            }
            .indicator-wrapper {
                min-height: 150px;
            }
            .main-price {
                font-size: 2.5rem; /* Thu nhỏ chữ giá một chút */
            }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 id="authTitle">SYSTEM LOGIN</h2>
            <div class="input-group">
                <label>EMAIL / OPERATOR ID</label>
                <input type="text" id="email" placeholder="ENTER ID">
            </div>
            <div class="input-group">
                <label>PASSCODE</label>
                <input type="password" id="password" placeholder="••••••">
            </div>
            <div style="text-align: left; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="rememberMe" checked style="width: auto; cursor: pointer;">
                <label for="rememberMe" style="font-size: 0.8rem; cursor: pointer; color: #888;">Remember Me</label>
            </div>
            <div id="loginMsg" style="color:var(--down-color);"></div>
            <button id="mainAuthBtn">LOGIN</button>
            <div class="toggle-auth" id="toggleAuthBtn">NEW OPERATOR? REGISTER ACCESS</div>
        </div>
        <div class="secure-text">SECURE CONNECTION V2.0</div>
    </div>

    <div class="main-app" id="mainApp">
        <header>
            <div class="brand"><i class="fas fa-cube"></i> STABLE<span>CAST</span> <sup style="font-size:0.6rem; color:#888; border:1px solid #333; padding:2px 5px; border-radius:3px;">TEAM 1 - ADY201m</sup></div>
            <div class="market-ticker" id="tickerStatus" style="color:var(--up-color); font-weight: bold;"><i class="fas fa-circle-notch fa-spin"></i> SYNCING...</div>
        </header>

        <div class="grid-container">
            <div class="panel">
                <div class="panel-header"><span>Order Book (BTC/USDT)</span> <i class="fas fa-list"></i></div>
                <div id="orderBook" style="font-family:'JetBrains Mono'"></div> 
                
                <div class="panel-header" style="margin-top:20px;"><span>System Specs</span> <i class="fas fa-server"></i></div>
                <div style="font-size:0.8rem; color:#888;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Latency</span> <span style="color:var(--up-color)">12ms</span></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Model RAM</span> <span>14.2 GB</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Data Origin</span> <span>Binance Live</span></div>
                </div>
            </div>

            <div class="panel" style="padding:0;">
                <div class="chart-wrapper">
                    <div class="price-overlay">
                        <div style="font-size:0.8rem; color:#888; font-weight:bold; display: flex; gap: 12px; align-items: center;">
                            BTC/USDT PERPETUAL
                            <span style="color: var(--up-color); font-size: 0.7rem;">■ REAL-TIME</span>
                            <span style="color: var(--accent-color); font-size: 0.7rem;">╍ AI FORECAST</span>
                        </div>
                        <div class="main-price" id="mainPrice">LOADING...</div>
                        <div id="priceChange" style="color:var(--up-color); font-weight:bold;">0.00%</div>
                    </div>
                    <canvas id="priceChart"></canvas>
                </div>
                <div class="indicator-wrapper">
                    <div style="position:absolute; top:5px; left:10px; font-size:0.7rem; color:#666; font-weight:bold;">RSI (14) - REAL DATA</div>
                    <canvas id="indicatorChart"></canvas>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header"><span>AI Prediction Engine</span> <i class="fas fa-brain"></i></div>
                
                <div class="ai-confidence">
                    <div style="margin-bottom: 15px;">
                        <div style="font-size:0.75rem; color:#3b82f6; text-transform:uppercase; font-weight:bold; margin-bottom:2px;">AI Forecast (Next 1H)</div>
                        <div id="aiPredPrice" style="font-size:2.2rem; font-weight:bold; color:#fff; font-family:'Rajdhani', sans-serif;">LOADING...</div>
                    </div>
                    <div class="conf-circle" id="confCircle">
                        <div class="conf-value" id="aiConf">--%</div>
                        <div class="conf-label">CONFIDENCE</div>
                    </div>
                </div>

                <div class="signal-box" id="signalBox">
                    <div style="font-size:0.7rem; color:#888; margin-bottom: 5px;">RECOMMENDED ACTION</div>
                    <div class="signal-text" id="aiSignal">ANALYZING</div>
                </div>

                <div class="params-box">
                    <div class="param-row"><span class="param-label">Stop Loss (ATR)</span> <span class="param-val" id="slVal" style="color:var(--down-color)">---</span></div>
                    <div class="param-row"><span class="param-label">Take Profit</span> <span class="param-val" id="tpVal" style="color:var(--up-color)">---</span></div>
                    <div class="param-row" style="border-top:1px solid #222; padding-top:8px; margin-top:8px;">
                        <span class="param-label">RSI (14)</span> <span class="param-val" id="rsiVal">---</span>
                    </div>
                    <div class="param-row" style="margin-bottom:0;"><span class="param-label">MACD (12,26)</span> <span class="param-val" id="macdVal">---</span></div>
                </div>

                <div class="panel-header" style="margin-top:20px;"><span>Live Market Sentiment</span> <i class="fas fa-globe"></i></div>
                <div class="news-feed" id="newsFeed"></div>
            </div>
        </div>

        <div class="project-footer">
            <span class="highlight-text">DISCLAIMER:</span> This project is developed for educational purposes within the <span class="highlight-text">ADY201m course (FPT University)</span>. 
            All data, market indicators, and AI predictions are simulated for demonstration only and do not hold real-world financial value. 
            Not intended for actual trading or investment advice. &copy; 2026 Team 1.
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- AUTH LOGIC ---
            const loginOverlay = document.getElementById('loginOverlay');
            const mainApp = document.getElementById('mainApp');
            const btnLogin = document.getElementById('mainAuthBtn');
            const toggleBtn = document.getElementById('toggleAuthBtn');
            const title = document.getElementById('authTitle');
            const msg = document.getElementById('loginMsg');
            let isRegister = false;

            toggleBtn.addEventListener('click', () => {
                isRegister = !isRegister;
                msg.textContent = "";
                if(isRegister) {
                    title.textContent = "SYSTEM REGISTER";
                    btnLogin.textContent = "REGISTER ACCESS";
                    toggleBtn.textContent = "ALREADY HAVE AN ACCOUNT? LOGIN";
                    btnLogin.style.background = "#3b82f6";
                    title.style.borderBottomColor = "#3b82f6";
                } else {
                    title.textContent = "SYSTEM LOGIN";
                    btnLogin.textContent = "LOGIN";
                    toggleBtn.textContent = "NEW OPERATOR? REGISTER ACCESS";
                    btnLogin.style.background = "#0ecb81";
                    title.style.borderBottomColor = "#0ecb81";
                }
            });

            btnLogin.addEventListener('click', () => {
                const u = document.getElementById('email').value;
                const p = document.getElementById('password').value;
                if(!u && !p && !isRegister) { enterApp(); return; }
                if(!u || !p) { msg.textContent = "Please enter credentials."; return; }
                if(isRegister) {
                    msg.style.color = "#3b82f6"; msg.textContent = "Registration Success! Please Login.";
                    setTimeout(() => toggleBtn.click(), 1000);
                } else { enterApp(); }
            });

            function enterApp() {
                msg.style.color = "#0ecb81";
                msg.textContent = "CONNECTING TO BINANCE API...";
                setTimeout(() => {
                    loginOverlay.style.opacity = 0;
                    setTimeout(() => {
                        loginOverlay.style.display = 'none';
                        mainApp.style.display = 'flex';
                        setTimeout(() => mainApp.style.opacity = 1, 100);
                        initNewsEngine();
                        startCoreEngine();
                    }, 500);
                }, 800);
            }

            // --- NEWS ENGINE CHỐNG TRỐNG ---
            let globalNewsArray = [
                { title: "Bitcoin approaches key resistance level amidst market uncertainty", source: "CoinTelegraph", time: "Just now", sentiment: "pos", url: "#" },
                { title: "SEC delays decision on latest Ethereum ETF applications", source: "CoinDesk", time: "5 mins ago", sentiment: "neg", url: "#" },
                { title: "Whale activity spikes as $500M USDT moves to Binance", source: "CryptoQuant", time: "12 mins ago", sentiment: "neg", url: "#" },
                { title: "New AI models show unprecedented accuracy in crypto forecasting", source: "Forbes", time: "1 hr ago", sentiment: "pos", url: "#" },
                { title: "Market volatility expected to increase ahead of Fed meeting", source: "Bloomberg", time: "2 hrs ago", sentiment: "neg", url: "#" }
            ];

            function renderNews() {
                const feed = document.getElementById('newsFeed');
                if(!feed) return;
                
                let html = '';
                for(let i = 0; i < Math.min(4, globalNewsArray.length); i++) {
                    const item = globalNewsArray[i];
                    const label = item.sentiment === 'pos' ? "BULLISH" : "BEARISH";
                    const sentClass = item.sentiment === 'pos' ? "sent-pos" : "sent-neg";
                    html += `
                        <a href="${item.url}" target="_blank" class="news-item">
                            <div class="news-title">${item.title}</div>
                            <div class="news-meta">
                                <span>${item.source} • ${item.time}</span>
                                <span class="sentiment-tag ${sentClass}">${label}</span>
                            </div>
                        </a>
                    `;
                }
                feed.innerHTML = html;
            }

            function initNewsEngine() {
                renderNews();
                setInterval(() => {
                    const first = globalNewsArray.shift();
                    globalNewsArray.push(first);
                    renderNews();
                }, 5000);

                fetch('https://min-api.cryptocompare.com/data/v2/news/?lang=EN')
                    .then(res => res.json())
                    .then(data => {
                        if(data && data.Data && data.Data.length > 0) {
                            globalNewsArray = data.Data.map(article => {
                                const titleLower = article.title.toLowerCase();
                                let sent = "pos";
                                if(titleLower.match(/(drop|bear|crash|hack|sec|ban|sell|fall|down|worry|plunge|fraud|delay)/)) {
                                    sent = "neg";
                                }
                                const date = new Date(article.published_on * 1000);
                                const timeStr = ("0" + date.getHours()).slice(-2) + ":" + ("0" + date.getMinutes()).slice(-2);
                                return {
                                    title: article.title,
                                    source: article.source_info.name,
                                    time: timeStr,
                                    sentiment: sent,
                                    url: article.url
                                };
                            });
                            renderNews();
                        }
                    }).catch(e => console.log("Using fallback news."));
            }

            // --- CORE ENGINE (BINANCE API & WEBSOCKET) ---
            async function startCoreEngine() {
                let history = [];
                let aiHistory = []; 
                let labels = [];

                try {
                    const res = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=100');
                    const data = await res.json();
                    history = data.map(d => parseFloat(d[4]));
                    labels = data.map((_, i) => i);
                    aiHistory = history.map(p => p + (Math.random() - 0.5) * (p * 0.0015)); 
                    document.getElementById('tickerStatus').innerHTML = '<i class="fas fa-check-circle"></i> BINANCE LIVE STREAM';
                } catch (e) {
                    let price = 43250.00;
                    history = Array.from({length: 100}, () => { price += (Math.random() - 0.5) * 100; return price; });
                    aiHistory = history.map(p => p + (Math.random() - 0.5) * 50);
                    labels = Array.from({length: 100}, (_,i) => i);
                }

                const ctxP = document.getElementById('priceChart').getContext('2d');
                const pChart = new Chart(ctxP, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Real Price', data: history, borderColor: '#0ecb81', borderWidth: 2, pointRadius: 0, fill: true,
                                backgroundColor: (ctx) => {
                                    const grad = ctx.chart.ctx.createLinearGradient(0,0,0,400);
                                    grad.addColorStop(0, 'rgba(14, 203, 129, 0.15)'); grad.addColorStop(1, 'rgba(14, 203, 129, 0)');
                                    return grad;
                                }, tension: 0.2
                            },
                            {
                                label: 'AI Forecast', data: aiHistory, borderColor: '#3b82f6', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, fill: false, tension: 0.2
                            }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: {legend: false}, scales: {x:{display:false}, y:{position:'right', grid:{color:'#1f2937'}}} }
                });

                const ctxI = document.getElementById('indicatorChart').getContext('2d');
                const iChart = new Chart(ctxI, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: 'RSI', data: calcRSI(history), borderColor: '#3b82f6', borderWidth: 1.5, pointRadius: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: {legend: false}, scales: {x:{display:false}, y:{position:'right', min:0, max:100, grid:{color:'#1f2937'}}} }
                });

                const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@ticker');
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    const currentPrice = parseFloat(data.c); 
                    const changePercent = parseFloat(data.P);

                    history.shift(); history.push(currentPrice);
                    
                    const rsiData = calcRSI(history);
                    const currentRSI = rsiData[rsiData.length - 1];
                    const macdArray = calcMACD(history);
                    const currentMACD = macdArray[macdArray.length - 1];

                    const predPrice = updateAI(currentRSI, currentMACD, changePercent, currentPrice);
                    
                    aiHistory.shift(); aiHistory.push(predPrice);

                    pChart.data.datasets[0].data = history; 
                    pChart.data.datasets[1].data = aiHistory; 
                    pChart.update(); 
                    
                    iChart.data.datasets[0].data = rsiData;
                    iChart.update();

                    const elP = document.getElementById('mainPrice');
                    elP.innerText = currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    elP.style.color = changePercent >= 0 ? '#0ecb81' : '#f6465d';
                    
                    const elC = document.getElementById('priceChange');
                    elC.innerText = (changePercent >= 0 ? "+" : "") + changePercent.toFixed(2) + "%";
                    elC.style.color = changePercent >= 0 ? '#0ecb81' : '#f6465d';

                    updateOrderBook(currentPrice);
                };
            }

            // --- MATH HELPERS ---
            function calcEMA(data, period) {
                let k = 2/(period+1), ema=data[0], res=[];
                data.forEach(p => { ema = p*k + ema*(1-k); res.push(ema); });
                return res;
            }

            function calcMACD(data) {
                let ema12 = calcEMA(data, 12);
                let ema26 = calcEMA(data, 26);
                let macd = [];
                for(let i=0; i<data.length; i++) macd.push(ema12[i] - ema26[i]);
                return macd;
            }

            function calcRSI(data) {
                let res = Array(14).fill(50);
                for(let i=14; i<data.length; i++) {
                    let up = 0, down = 0;
                    for(let j=i-14; j<i; j++) {
                        let diff = data[j+1] - data[j];
                        if(diff > 0) up += diff; else down -= diff;
                    }
                    if (down === 0) res.push(100);
                    else res.push(100 - (100 / (1 + up / down)));
                }
                return res;
            }

            function updateOrderBook(p) {
                let h = "";
                for(let i=5; i>0; i--) h += `<div class="ob-row bg-red-soft"><span style="color:#f6465d">${(p+i*1.5).toFixed(2)}</span> <span style="color:#888">${(Math.random()*2).toFixed(3)}</span></div>`;
                h += `<div style="text-align:center; color:#fff; font-weight:bold; margin:3px 0;">${p.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>`;
                for(let i=1; i<=5; i++) h += `<div class="ob-row bg-green-soft"><span style="color:#0ecb81">${(p-i*1.5).toFixed(2)}</span> <span style="color:#888">${(Math.random()*2).toFixed(3)}</span></div>`;
                document.getElementById('orderBook').innerHTML = h;
            }

            // --- CẬP NHẬT AI & THÔNG SỐ ---
            function updateAI(rsi, macd, chg, price) {
                let sig = "HOLD", col = "#888";
                
                let conf = 45 + Math.random() * 15; 
                let predOffset = (Math.random() - 0.5) * (price * 0.001);

                if (rsi > 65 || (macd < 0 && chg < -0.5)) {
                    sig = "SELL"; col = "#f6465d";
                    conf = 65 + Math.random() * 15;
                    predOffset = -(price * (0.005 + Math.random() * 0.005));
                    if(rsi > 75) { sig = "STRONG SELL"; conf += 5; }
                } 
                else if (rsi < 35 || (macd > 0 && chg > 0.5)) {
                    sig = "BUY"; col = "#0ecb81";
                    conf = 65 + Math.random() * 15;
                    predOffset = (price * (0.005 + Math.random() * 0.005));
                    if(rsi < 25) { sig = "STRONG BUY"; conf += 5; }
                }

                if(conf > 88.5) conf = 88.5 - Math.random();

                const predPrice = price + predOffset;

                let sl, tp;
                if(sig.includes("BUY")) {
                    sl = price * 0.985; tp = price * 1.03;
                } else if(sig.includes("SELL")) {
                    sl = price * 1.015; tp = price * 0.97;
                } else {
                    sl = price * 0.99; tp = price * 1.01;
                }

                document.getElementById('aiSignal').innerText = sig;
                document.getElementById('aiSignal').style.color = col;
                document.getElementById('signalBox').style.borderColor = col;
                
                document.getElementById('aiConf').innerText = conf.toFixed(1) + "%";
                document.querySelector('.conf-circle').style.borderColor = col;

                document.getElementById('aiPredPrice').innerText = predPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('aiPredPrice').style.color = col;

                document.getElementById('slVal').innerText = sl.toLocaleString('en-US', {minimumFractionDigits: 2});
                document.getElementById('tpVal').innerText = tp.toLocaleString('en-US', {minimumFractionDigits: 2});
                
                document.getElementById('rsiVal').innerText = rsi.toFixed(2);
                document.getElementById('rsiVal').style.color = rsi > 70 ? "#f6465d" : (rsi < 30 ? "#0ecb81" : "#fff");

                document.getElementById('macdVal').innerText = macd.toFixed(2);
                document.getElementById('macdVal').style.color = macd > 0 ? "#0ecb81" : "#f6465d";

                return predPrice; 
            }
        });
    </script>
</body>
</html>
